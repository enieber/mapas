services:
  ngixmapas:
    image: nginx:latest
    volumes:
     - ./docker-data/public-files:/var/www/html/files
     - ./docker-data/assets:/var/www/html/assets

     # to prevent 404
     - /dev/null:/var/www/html/index.php
     - ./docker/production/nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "0.0.0.0:8888:80"
    depends_on:
      - mapas
    links:
      - mapas
  mapas:
    env_file:
      - ./.env
    build:
      context: ./
      dockerfile: docker/Dockerfile
    # ports:
    #   - "9000:9000"
    volumes:
      # scripts principais
      # - ./docker/entrypoint.sh:/entrypoint.sh
      # - ./docker/jobs-cron.sh:/jobs-cron.sh
      # - ./docker/recreate-pending-pcache-cron.sh:/recreate-pending-pcache-cron.sh

      - ./config:/var/www/config
      - ./public:/var/www/html
      # - ./scripts:/var/www/scripts
      - ./src:/var/www/src
      - ./app:/var/www/app
      # - ./var:/var/www/var
      # - ./vendor:/var/www/vendor
      # - ./docker/development/router.php:/var/www/router.php
      # - ./config.d:/var/www/config/config.d
      # - ./.php-cs-fixer.php:/var/www/.php-cs-fixer.php

      # - ./docker-data/assets:/var/www/html/assets
      # - ./docker-data/public-files:/var/www/html/files
      # - ./docker-data/private-files:/var/www/private-files

      - ./.env:/.env
      - ./docker-data/assets:/var/www/html/assets
      - ./docker-data/public-files:/var/www/html/files
      - ./docker-data/private-files:/var/www/var/private-files
      - ./docker-data/saas-files:/var/www/var/saas-files
      - ./docker-data/sessions:/var/www/var/sessions
      - ./docker-data/logs:/var/www/var/logs
    links:
      - db
      - redis
      - sessions
    environment:
      - POSTGRES_PASSWORD=mapas
      - POSTGRES_USER=mapas
      - POSTGRES_DB=mapas

#      - APP_LCODE=pt_BR,es_ES # para selecao do idioma baseado no navegador
      - APP_LCODE=pt_BR

      - REDIS_CACHE=redis
      - SESSIONS_SAVE_PATH=tcp://sessions:6379
    depends_on:
      - db
      - redis
      - sessions
  db:
    image: postgis/postgis:14-master
    environment:
      - POSTGRES_PASSWORD=mapas
      - POSTGRES_USER=mapas
      - POSTGRES_DB=mapas
      - POSTGRES_DB_TEST=mapasculturais_test
    ports:
      - "5432:5432"
    volumes:
      - ./docker-data/postgres:/var/lib/postgresql/data
      - ./dev/db:/docker-entrypoint-initdb.d
  
  redis:
    image: redis:6
    command: --maxmemory 1256Mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
 
  sessions:
    image: redis:6
    command: --maxmemory 384Mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    volumes:
      - ./docker-data/sessions:/data


